name: Weekly Model Training

on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    # Allow manual trigger with custom parameters
    inputs:
      symbols:
        description: 'Symbols to train (comma-separated, e.g., BTCUSDT,ETHUSDT)'
        required: false
        default: 'BTCUSDT,ETHUSDT'
      days:
        description: 'Days of training data'
        required: false
        default: '730'
      epochs:
        description: 'Training epochs'
        required: false
        default: '300'

permissions:
  contents: read
  issues: write  # For creating issues on failure

env:
  AWS_REGION: us-east-1
  PYTHON_VERSION: '3.11'

jobs:
  train-models:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max for all training

    strategy:
      fail-fast: false
      matrix:
        symbol: ${{ fromJson(github.event.inputs.symbols && format('["{0}"]', join(fromJson(format('["{0}"]', github.event.inputs.symbols)), '","')) || '["BTCUSDT", "ETHUSDT"]') }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install boto3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Train model on SageMaker
      env:
        SAGEMAKER_ROLE_ARN: ${{ secrets.SAGEMAKER_ROLE_ARN }}
        SAGEMAKER_S3_BUCKET: ${{ secrets.SAGEMAKER_S3_BUCKET }}
        SAGEMAKER_DOCKER_IMAGE: ${{ secrets.SAGEMAKER_DOCKER_IMAGE }}
      run: |
        echo "Training ${{ matrix.symbol }} model..."

        atb train cloud ${{ matrix.symbol }} \
          --days ${{ github.event.inputs.days || '730' }} \
          --epochs ${{ github.event.inputs.epochs || '300' }} \
          --timeframe 1h \
          --instance-type ml.g4dn.xlarge

    - name: Upload training logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: training-logs-${{ matrix.symbol }}
        path: logs/
        retention-days: 30
        if-no-files-found: ignore

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: train-models
    if: failure()

    steps:
    - name: Create issue on failure
      uses: actions/github-script@v7
      with:
        script: |
          const date = new Date().toISOString().split('T')[0];
          const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `[Automated] Weekly model training failed - ${date}`,
            body: `## Weekly Model Training Failed

            The automated weekly model training workflow has failed.

            **Run Details:**
            - Date: ${date}
            - Workflow Run: ${runUrl}
            - Trigger: ${context.eventName === 'schedule' ? 'Scheduled (weekly)' : 'Manual'}

            **Next Steps:**
            1. Check the [workflow logs](${runUrl}) for error details
            2. Verify AWS credentials are valid
            3. Check SageMaker quotas and limits
            4. Re-run the workflow manually after fixing issues

            ---
            *This issue was created automatically by the weekly training workflow.*
            `,
            labels: ['automation', 'training', 'bug']
          });

  training-summary:
    runs-on: ubuntu-latest
    needs: train-models
    if: success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        pip install boto3

    - name: Generate training summary
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: ${{ env.AWS_REGION }}
        SAGEMAKER_S3_BUCKET: ${{ secrets.SAGEMAKER_S3_BUCKET }}
      run: |
        echo "## Weekly Training Summary" > $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Models Trained" >> $GITHUB_STEP_SUMMARY
        echo "- BTCUSDT" >> $GITHUB_STEP_SUMMARY
        echo "- ETHUSDT" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- Days of data: ${{ github.event.inputs.days || '730' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Epochs: ${{ github.event.inputs.epochs || '300' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Instance type: ml.g4dn.xlarge (T4 GPU)" >> $GITHUB_STEP_SUMMARY
        echo "- Spot instances: Yes" >> $GITHUB_STEP_SUMMARY
