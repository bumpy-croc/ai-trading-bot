name: Codex Review Autofix Agent

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: read
  actions: read
  issues: read

jobs:
  # Codex review autofix agent - triggers on PR comments by chatgpt-codex-connector
  codex_review_autofix:
    if: ${{ github.event.issue.pull_request && github.event.comment.user.login == 'chatgpt-codex-connector' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: read
      actions: read
      issues: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check Comment Content
      id: check-comment
      run: |
        echo "=== Checking PR comment content ==="

        COMMENT_BODY="${{ github.event.comment.body }}"
        echo "Comment author: ${{ github.event.comment.user.login }}"
        echo "Comment body length: ${#COMMENT_BODY}"

        # Check if comment contains the "no major issues" text
        if echo "$COMMENT_BODY" | grep -q "Codex Review: Didn't find any major issues"; then
          echo "Found 'Codex Review: Didn't find any major issues' - stopping workflow"
          echo "should_stop=true" >> $GITHUB_OUTPUT
        else
          echo "No 'Codex Review: Didn't find any major issues' found - launching agent"
          echo "should_stop=false" >> $GITHUB_OUTPUT
        fi

    - name: Launch Cursor Agent for PR Fix
      if: steps.check-comment.outputs.should_stop == 'false'
      run: |
        echo "=== Launching Cursor Agent for PR Comment Fix ==="

        # Get PR information
        PR_NUMBER="${{ github.event.issue.number }}"
        PR_BRANCH="${{ github.event.repository.default_branch }}"
        COMMENT_BODY="${{ github.event.comment.body }}"

        echo "PR Number: $PR_NUMBER"
        echo "Repository: ${{ github.repository }}"
        echo "Comment author: ${{ github.event.comment.user.login }}"

        # Construct the prompt for fixing the PR comment
        cat > prompt.txt << EOF
        Fix this PR comment

        $COMMENT_BODY

        Once you fixed the comment, leave another comment on the PR saying "@codex review"
        EOF

        echo "=== Sending to Cursor Agent ==="

        # Launch Cursor background agent
        curl -X POST "https://api.cursor.com/v0/agents" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.CURSOR_API_KEY }}" \
          -d "{ \"prompt\": { \"text\": $(cat prompt.txt | jq -Rs .) }, \"source\": { \"repository\": \"${{ github.server_url }}/${{ github.repository }}\", \"ref\": \"$PR_BRANCH\" } }"

        echo ""
        echo "=== Cursor Agent Launched ==="
        echo "The agent will fix the issues mentioned in the PR comment and add a @codex review comment when done."

        # Cleanup temporary files
        rm -f prompt.txt

    - name: Log Workflow Details
      run: |
        echo "=== PR Comment Autofix Summary ==="
        echo "Repository: ${{ github.repository }}"
        echo "PR: ${{ github.event.issue.number }}"
        echo "Comment author: ${{ github.event.comment.user.login }}"
        echo "Should stop: ${{ steps.check-comment.outputs.should_stop }}"
        if [[ "${{ steps.check-comment.outputs.should_stop }}" == "false" ]]; then
          echo "Cursor agent launched to fix PR comment issues"
        else
          echo "Workflow stopped - no major issues found in comment"
        fi
