name: Codex Review Autofix Agent

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: read
  actions: read
  issues: read

jobs:
  # Codex review autofix agent - triggers on PR comments by chatgpt-codex-connector (excluding agent completion comments)
  codex_review_autofix:
    if: ${{ github.event.issue.pull_request && github.event.comment.user.login == 'chatgpt-codex-connector' && !contains(github.event.comment.body, '@codex review') && !contains(github.event.comment.body, 'Codex fixes applied') }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: read
      actions: read
      issues: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check Comment Content
      id: check-comment
      run: |
        echo "=== Checking PR comment content ==="

        COMMENT_BODY="${{ github.event.comment.body }}"
        echo "Comment author: ${{ github.event.comment.user.login }}"
        echo "Comment body length: ${#COMMENT_BODY}"

        # Check if comment contains the "no major issues" text
        if echo "$COMMENT_BODY" | grep -q "Codex Review: Didn't find any major issues"; then
          echo "Found 'Codex Review: Didn't find any major issues' - stopping workflow"
          echo "should_stop=true" >> $GITHUB_OUTPUT
        else
          echo "No 'Codex Review: Didn't find any major issues' found - launching agent"
          echo "should_stop=false" >> $GITHUB_OUTPUT
        fi

    - name: Get PR Branch Information
      if: steps.check-comment.outputs.should_stop == 'false'
      id: pr-info
      run: |
        echo "=== Getting PR branch information ==="

        PR_NUMBER="${{ github.event.issue.number }}"
        REPO="${{ github.repository }}"
        TOKEN="${{ secrets.GITHUB_TOKEN }}"
        echo "PR Number: $PR_NUMBER"
        echo "Repository: $REPO"

        # Ensure required tools are available
        if ! command -v jq >/dev/null 2>&1; then
          echo "Error: jq is required but not available"
          exit 1
        fi

        # Get PR details using GitHub REST API directly (more reliable than gh CLI)
        API_URL="https://api.github.com/repos/$REPO/pulls/$PR_NUMBER"
        echo "API URL: $API_URL"

        if ! PR_DATA=$(curl -s -H "Authorization: token $TOKEN" -H "Accept: application/vnd.github.v3+json" "$API_URL"); then
          echo "Error: Failed to fetch PR data for #$PR_NUMBER"
          exit 1
        fi

        # Check if API call was successful (GitHub API returns error objects)
        if echo "$PR_DATA" | jq -e '.message' >/dev/null 2>&1; then
          ERROR_MSG=$(echo "$PR_DATA" | jq -r '.message')
          echo "Error: GitHub API returned error: $ERROR_MSG"
          exit 1
        fi

        # Extract the head branch (the branch with the changes)
        PR_BRANCH=$(echo "$PR_DATA" | jq -r '.head.ref')
        PR_HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')

        # Validate that we got valid data
        if [[ "$PR_BRANCH" == "null" || -z "$PR_BRANCH" ]]; then
          echo "Error: Could not determine PR branch from API response"
          echo "API Response: $PR_DATA"
          echo "This likely means the PR does not exist or access is denied"
          exit 1
        fi

        # Additional validation - ensure branch name looks reasonable
        if [[ ! "$PR_BRANCH" =~ ^[a-zA-Z0-9._/-]+$ ]] || [[ ${#PR_BRANCH} -gt 255 ]]; then
          echo "Error: PR branch name '$PR_BRANCH' appears invalid"
          exit 1
        fi

        # Ensure this is not accidentally the default branch (main/master/develop)
        DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
        if [[ "$PR_BRANCH" == "$DEFAULT_BRANCH" ]]; then
          echo "Warning: PR branch matches repository default branch ($DEFAULT_BRANCH)"
          echo "This might indicate an issue with the PR data retrieval"
          # Don't exit here as it could be a legitimate case, but log the warning
        fi

        echo "PR Branch: $PR_BRANCH"
        echo "PR Head SHA: $PR_HEAD_SHA"
        echo "pr_branch=$PR_BRANCH" >> $GITHUB_OUTPUT
        echo "pr_head_sha=$PR_HEAD_SHA" >> $GITHUB_OUTPUT

    - name: Launch Cursor Agent for PR Fix
      if: steps.check-comment.outputs.should_stop == 'false'
      run: |
        echo "=== Launching Cursor Agent for PR Comment Fix ==="

        # Get PR information
        PR_NUMBER="${{ github.event.issue.number }}"
        PR_BRANCH="${{ steps.pr-info.outputs.pr_branch }}"
        PR_HEAD_SHA="${{ steps.pr-info.outputs.pr_head_sha }}"
        COMMENT_BODY="${{ github.event.comment.body }}"

        # Validate that we have the required information
        if [[ -z "$PR_BRANCH" ]]; then
          echo "Error: PR branch information is missing - cannot proceed with agent launch"
          exit 1
        fi

        echo "PR Number: $PR_NUMBER"
        echo "PR Branch: $PR_BRANCH"
        echo "PR Head SHA: $PR_HEAD_SHA"
        echo "Repository: ${{ github.repository }}"
        echo "Comment author: ${{ github.event.comment.user.login }}"

        # Construct the prompt for fixing the PR comment
        cat > prompt.txt << EOF
        Fix this PR comment

        $COMMENT_BODY

        Once you fixed the comment, leave another comment on the PR saying "Codex fixes applied - ready for review"
        EOF

        echo "=== Sending to Cursor Agent ==="

        # Launch Cursor background agent
        curl -X POST "https://api.cursor.com/v0/agents" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.CURSOR_API_KEY }}" \
          -d "{ \"prompt\": { \"text\": $(cat prompt.txt | jq -Rs .) }, \"source\": { \"repository\": \"${{ github.server_url }}/${{ github.repository }}\", \"ref\": \"$PR_BRANCH\" } }"

        echo ""
        echo "=== Cursor Agent Launched ==="
        echo "The agent will fix the issues mentioned in the PR comment and add a completion comment when done."

        # Cleanup temporary files
        rm -f prompt.txt

    - name: Log Workflow Details
      run: |
        echo "=== PR Comment Autofix Summary ==="
        echo "Repository: ${{ github.repository }}"
        echo "PR: ${{ github.event.issue.number }}"
        echo "Comment author: ${{ github.event.comment.user.login }}"
        echo "Should stop: ${{ steps.check-comment.outputs.should_stop }}"
        if [[ "${{ steps.check-comment.outputs.should_stop }}" == "false" ]]; then
          echo "PR Branch: ${{ steps.pr-info.outputs.pr_branch }}"
          echo "PR Head SHA: ${{ steps.pr-info.outputs.pr_head_sha }}"
          echo "Cursor agent launched to fix PR comment issues"
        else
          echo "Workflow stopped - no major issues found in comment"
        fi
