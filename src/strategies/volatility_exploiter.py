"""
Volatility Exploiter Strategy - Profit from Market Chaos

This strategy exploits high volatility environments by increasing trading
activity and position sizes when volatility is elevated. It adapts to
volatility regimes and adjusts risk/reward accordingly.

Volatility Trading Thesis:
- High volatility = Larger price swings = More profit opportunity
- High volatility periods don't last forever (mean reversion)
- Most traders fear volatility; we embrace it for alpha
- Combine with proper risk management to profit from chaos

Strategy Behavior by Volatility State:
1. HIGH VOLATILITY:
   - Larger position sizes (more opportunity)
   - Wider stops (avoid whipsaws)
   - Momentum-based entries
   - Quick profit taking

2. EXPANDING VOLATILITY:
   - Early momentum entries
   - Prepare for larger swings
   - Scale into positions

3. LOW VOLATILITY:
   - Smaller positions
   - Wait for breakout
   - Reduce activity

4. CONTRACTING VOLATILITY:
   - Take profits
   - Reduce exposure
   - Prepare for regime change

Expected Performance:
- Max Drawdown: 40-50%
- Sharpe Ratio: 1.0-1.5
- Win Rate: 50-60%
- Profit Factor: 2.0-2.5
- Best in: High volatility periods (2020, 2021, 2022)
- Worst in: Low volatility grinding markets

Historical Volatility Opportunities:
- March 2020 COVID: Extreme volatility, large swings
- May 2021 Crash: High volatility reversal
- 2022 Bear: Sustained high volatility
- Bull runs: Volatility expansion on rallies
"""

from __future__ import annotations

from src.strategies.components import (
    ConfidenceWeightedSizer,
    EnhancedRegimeDetector,
    RegimeAdaptiveRiskManager,
    Strategy,
)
from src.strategies.components.volatility_exploitation_signal_generator import (
    VolatilityExploitationSignalGenerator,
)


def create_volatility_exploiter_strategy(
    name: str = "VolatilityExploiter",
    # Volatility detection parameters
    atr_high_threshold: float = 2.0,
    atr_low_threshold: float = 0.5,
    bb_width_high: float = 0.20,
    bb_width_low: float = 0.05,
    # Position sizing (adaptive to volatility)
    base_fraction: float = 0.35,  # Moderate base
    max_fraction: float = 0.50,  # Allow larger in high vol
    min_fraction: float = 0.15,  # Reduce in low vol
    # Risk management (adaptive stops)
    low_vol_stop: float = 0.04,  # 4% stop in low volatility
    high_vol_stop: float = 0.12,  # 12% stop in high volatility
    take_profit_pct: float = 0.25,  # 25% profit target
) -> Strategy:
    """
    Create volatility exploitation strategy

    This strategy increases activity and position sizes during high
    volatility periods while reducing exposure in low volatility.

    Args:
        name: Strategy name
        atr_high_threshold: ATR ratio for high volatility
        atr_low_threshold: ATR ratio for low volatility
        bb_width_high: BB width for high volatility
        bb_width_low: BB width for low volatility
        base_fraction: Base position size
        max_fraction: Maximum position in high volatility
        min_fraction: Minimum position in low volatility
        low_vol_stop: Stop loss in low volatility (tight)
        high_vol_stop: Stop loss in high volatility (wide)
        take_profit_pct: Take profit target

    Returns:
        Configured Strategy instance optimized for volatility exploitation

    Example:
        >>> strategy = create_volatility_exploiter_strategy()
        >>> # Backtest on volatile period
        >>> results = backtester.run(
        ...     symbol="BTCUSDT",
        ...     start=datetime(2020, 3, 1),  # COVID crash - high vol
        ...     end=datetime(2020, 6, 1),
        ... )
        >>> print(f"High Vol Return: {results['total_return']:.2f}%")
    """
    # Create volatility exploitation signal generator
    signal_generator = VolatilityExploitationSignalGenerator(
        name=f"{name}_signals",
        atr_high_threshold=atr_high_threshold,
        atr_low_threshold=atr_low_threshold,
        bb_width_high=bb_width_high,
        bb_width_low=bb_width_low,
    )

    # Create regime-adaptive risk manager
    # Adjusts stops based on volatility regime
    risk_manager = RegimeAdaptiveRiskManager(
        low_vol_risk=low_vol_stop,  # Tight stop in low vol
        high_vol_risk=high_vol_stop,  # Wide stop in high vol
        base_risk=0.08,  # Base 8% stop
    )

    # Create confidence-weighted position sizer
    position_sizer = ConfidenceWeightedSizer(
        base_fraction=base_fraction,
        min_confidence=0.55,
    )

    # Create regime detector
    regime_detector = EnhancedRegimeDetector()

    # Compose strategy
    strategy = Strategy(
        name=name,
        signal_generator=signal_generator,
        risk_manager=risk_manager,
        position_sizer=position_sizer,
        regime_detector=regime_detector,
        enable_logging=True,
    )

    # Configure volatility-adaptive risk overrides
    strategy._risk_overrides = {
        "position_sizer": "confidence_weighted",
        "base_fraction": base_fraction,
        "min_fraction": min_fraction,
        "max_fraction": max_fraction,
        "stop_loss_pct": 0.08,  # Base stop (adjusted by regime)
        "take_profit_pct": take_profit_pct,
        # Volatility-adaptive dynamic risk
        "dynamic_risk": {
            "enabled": True,
            # Moderate drawdown thresholds (expect volatility)
            "drawdown_thresholds": [0.20, 0.30, 0.40],
            "risk_reduction_factors": [0.85, 0.70, 0.50],
            "recovery_thresholds": [0.10, 0.20],
        },
        # Aggressive partial operations (capture volatility swings)
        "partial_operations": {
            "exit_targets": [0.10, 0.20, 0.35],  # Quick profits in volatility
            "exit_sizes": [0.30, 0.30, 0.30],  # Scale out evenly
            "scale_in_thresholds": [0.04, 0.08],  # Add on pullbacks
            "scale_in_sizes": [0.25, 0.20],
            "max_scale_ins": 2,
        },
        # Volatility-adaptive trailing stop
        "trailing_stop": {
            "activation_threshold": 0.08,  # Activate at 8%
            "trailing_distance_pct": 0.05,  # 5% trail (wider for volatility)
            "breakeven_threshold": 0.12,  # Later breakeven
            "breakeven_buffer": 0.02,
        },
    }

    # Store config
    strategy.config = {
        "base_fraction": base_fraction,
        "max_fraction": max_fraction,
        "min_fraction": min_fraction,
        "low_vol_stop": low_vol_stop,
        "high_vol_stop": high_vol_stop,
        "take_profit_pct": take_profit_pct,
        "atr_high_threshold": atr_high_threshold,
        "atr_low_threshold": atr_low_threshold,
    }

    return strategy


def create_ultra_volatile_exploiter_strategy(
    name: str = "UltraVolatileExploiter",
) -> Strategy:
    """
    Create ultra-aggressive variant for maximum volatility exploitation

    This variant maximizes profit from extreme volatility:
    - Maximum position sizes (50%)
    - Very wide stops (15%)
    - Very aggressive in high volatility
    - Minimal activity in low volatility

    Use when: Expecting extreme volatility (crashes, rallies)
    Expected: High returns with high drawdown

    Returns:
        Ultra-aggressive volatility exploiter configuration
    """
    return create_volatility_exploiter_strategy(
        name=name,
        base_fraction=0.45,  # Large base
        max_fraction=0.50,  # Maximum allowed
        min_fraction=0.10,  # Very low in calm
        low_vol_stop=0.03,  # Very tight in low vol
        high_vol_stop=0.15,  # Very wide in high vol
        take_profit_pct=0.40,  # Extended profits
        atr_high_threshold=1.8,  # Lower threshold (more aggressive)
    )


def create_conservative_volatility_exploiter_strategy(
    name: str = "ConservativeVolatilityExploiter",
) -> Strategy:
    """
    Create conservative variant for moderate volatility trading

    This variant is more conservative:
    - Smaller position sizes (30%)
    - Tighter stops (8%)
    - Less aggressive in high volatility
    - More active in moderate volatility

    Use when: Want volatility exposure with lower risk
    Expected: Moderate returns with moderate drawdown

    Returns:
        Conservative volatility exploiter configuration
    """
    return create_volatility_exploiter_strategy(
        name=name,
        base_fraction=0.25,  # Smaller base
        max_fraction=0.35,  # Conservative max
        min_fraction=0.15,  # Stay somewhat active
        low_vol_stop=0.05,  # Moderate tight
        high_vol_stop=0.10,  # Moderate wide
        take_profit_pct=0.20,  # Conservative profits
        atr_high_threshold=2.5,  # Higher threshold (more selective)
    )


def create_mean_reversion_volatility_strategy(
    name: str = "MeanReversionVolatility",
) -> Strategy:
    """
    Create mean-reversion focused variant

    This variant fades extreme volatility:
    - Enter OPPOSITE to momentum in extreme volatility
    - Bet on volatility contraction
    - Quick profits from mean reversion
    - Exit on volatility normalization

    Use when: Volatility extremely elevated (>90th percentile)
    Expected: High win rate, quick trades, medium returns

    Returns:
        Mean-reversion focused configuration
    """
    # Note: Would need custom signal generator for true mean reversion
    # This is a placeholder using conservative volatility exploitation
    return create_volatility_exploiter_strategy(
        name=name,
        base_fraction=0.30,
        max_fraction=0.40,
        min_fraction=0.20,
        low_vol_stop=0.04,
        high_vol_stop=0.08,  # Tighter stop in high vol (counter-trend)
        take_profit_pct=0.15,  # Quick profits
        atr_high_threshold=2.2,
    )
